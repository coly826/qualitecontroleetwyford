<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rapport Global QC</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ====== FORCE LES COULEURS A L'IMPRESSION ====== */
@media print {
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }

  body {
    background: #ffffff !important;
  }

  .navbar, .btn, form {
    display: none !important;
  }

  .badge {
    color: #fff !important;
    border-radius: 4px !important;
    padding: 4px 6px !important;
  }

  .table-primary {
    background-color: #cfe2ff !important;
  }
  .table-success {
    background-color: #d1e7dd !important;
  }
  .bg-secondary {
    background-color: #6c757d !important;
    color: #fff !important;
  }
  .bg-primary {
    background-color: #0d6efd !important;
    color: #fff !important;
  }
}
</style>
</head>

<body class="bg-light pt-5">

<nav class="navbar navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">ðŸ“Š RAPPORT GLOBAL QC</span>
    <a href="/dashboard" class="btn btn-light">â¬… Dashboard</a>
  </div>
</nav>

<div class="container-fluid mt-4">

<%
  const groupes = ["A","B","C"];
  const moisListe = [
    "Janvier","FÃ©vrier","Mars","Avril","Mai","Juin",
    "Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"
  ];
  const kListe = ["K1A","K1B","K1C","K2A","K2B","K2C","K3A","K3B","K3C"];

  const num = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);
%>

<% groupes.forEach(groupe => { 
   const dataGroupe = data.filter(d => d.groupe === groupe);
%>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-secondary text-white fw-bold">
    GROUPE <%= groupe %>
  </div>

  <div class="card-body">

  <% if (!dataGroupe.length) { %>
    <p class="text-muted fst-italic">Aucune donnÃ©e pour ce groupe.</p>
  <% } else { %>

  <% kListe.forEach(k => { 
     const dataK = dataGroupe.filter(d => d.k_option === k);
     if (!dataK.length) return;
  %>

  <h5 class="text-primary mt-3">ðŸ”¹ K : <%= k %></h5>

  <% moisListe.forEach(mois => {
     const dataMois = dataK.filter(d => d.mois === mois);
     if (!dataMois.length) return;

     const totalMois = dataMois.reduce((t,i)=>{
       t.cartons += num(i.cartons);
       t.pieces += num(i.pieces);
       t.etiquettes += num(i.etiquettes);
       t.edge += num(i.edge);
       t.surface += num(i.surface);
       t.broken += num(i.broken);
       return t;
     }, {cartons:0,pieces:0,etiquettes:0,edge:0,surface:0,broken:0});

     const totalDefautsMois =
       totalMois.pieces +
       totalMois.etiquettes +
       totalMois.edge +
       totalMois.surface +
       totalMois.broken;

     const pourcentageMois =
       totalMois.cartons > 0 ? (totalDefautsMois / totalMois.cartons) * 100 : 0;
  %>

  <h6 class="mt-3 text-secondary">ðŸ“… Mois : <%= mois %></h6>

  <div class="table-responsive">
  <table class="table table-bordered table-striped align-middle text-center">
    <thead class="table-primary">
      <tr>
        <th>Date</th>
        <th>Ligne</th>
        <th>T1</th>
        <th>T2</th>
        <th>T3</th>
        <th>Nbre Cartons contrÃ´lÃ©s</th>
        <th>PiÃ¨ces Manquantes</th>
        <th>Ã‰tiquettes Manquantes</th>
        <th>Edge</th>
        <th>Surface</th>
        <th>Broken</th>
        <th>% DÃ©fauts</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
    <% dataMois.forEach(l => { 
       const cartons = num(l.cartons);
       const defauts =
         num(l.pieces) +
         num(l.etiquettes) +
         num(l.edge) +
         num(l.surface) +
         num(l.broken);

       const pourcentage =
         cartons > 0 ? (defauts / cartons) * 100 : 0;
    %>
      <tr>
        <td><%= l.date %></td>
        <td><%= l.ligne %></td>
        <td><%= l.table_t1 %></td>
        <td><%= l.table_t2 %></td>
        <td><%= l.table_t3 %></td>
        <td><%= cartons %></td>
        <td><%= l.pieces %></td>
        <td><%= l.etiquettes %></td>
        <td><%= l.edge %></td>
        <td><%= l.surface %></td>
        <td><%= l.broken %></td>

        <!-- POURCENTAGE LIGNE -->
        <td>
          <span class="badge <%= pourcentage < 3 ? 'bg-success' : 'bg-danger' %>">
            <%= pourcentage.toFixed(2) %> %
          </span>
        </td>

        <td>
          <form action="/delete/<%= l._id %>" method="POST">
            <button class="btn btn-danger btn-sm"
              onclick="return confirm('Supprimer cette ligne ?');">
              ðŸ—‘
            </button>
          </form>
        </td>
      </tr>
    <% }) %>
    </tbody>

    <!-- TOTAL MOIS -->
    <tfoot>
      <tr class="table-success fw-bold">
        <td colspan="5">TOTAL DU MOIS</td>
        <td><%= totalMois.cartons %></td>
        <td><%= totalMois.pieces %></td>
        <td><%= totalMois.etiquettes %></td>
        <td><%= totalMois.edge %></td>
        <td><%= totalMois.surface %></td>
        <td><%= totalMois.broken %></td>

        <td>
          <span class="badge <%= pourcentageMois < 3 ? 'bg-success' : 'bg-danger' %>">
            <%= pourcentageMois.toFixed(2) %> %
          </span>
        </td>
        <td>-</td>
      </tr>
    </tfoot>
  </table>
  </div>

  <% }) %>
  <% }) %>
  <% } %>

  </div>
</div>

<% }) %>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
