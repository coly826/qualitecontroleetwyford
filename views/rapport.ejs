<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rapport Global QC</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">ðŸ“Š RAPPORT GLOBAL QC</span>
    <div class="ms-auto">
      <a href="/dashboard" class="btn btn-light btn-sm">â¬… Dashboard</a>
    </div>
  </div>
</nav>

<div class="container-fluid mt-5 pt-4 px-3">

<h4 class="text-primary mb-4">Historique des contrÃ´les (Tous utilisateurs)</h4>

<%
  const groupes = ["A","B","C"];
  const moisListe = [
    "Janvier","FÃ©vrier","Mars","Avril","Mai","Juin",
    "Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"
  ];
  const kListe = ["K1A","K1B","K1C","K2A","K2B","K2C","K3A","K3B","K3C"];
  const num = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);
%>

<!-- ================== PAR GROUPE ================== -->
<% groupes.forEach(groupe => { 
     const lignesGroupe = data.filter(d => d.groupe === groupe); 
%>

<div class="p-3 rounded bg-white shadow-sm mb-4">
  <h4 class="fw-bold text-secondary">ðŸŸ¦ GROUPE <%= groupe %></h4>

  <% if (!lignesGroupe.length) { %>
    <p class="text-muted fst-italic">Aucune donnÃ©e enregistrÃ©e pour ce groupe.</p>
  <% } else { %>

    <!-- ================== PAR K ================== -->
    <% kListe.forEach(kOption => { 
         const lignesK = lignesGroupe.filter(l => l.k_option === kOption);
         if (!lignesK.length) return;  // si aucun contrÃ´le pour ce K, skip

         // Totaux pour ce K
         const totalK = lignesK.reduce((t,i)=>{
           t.cartons += num(i.cartons);
           t.pieces += num(i.pieces);
           t.etiquettes += num(i.etiquettes);
           t.edge += num(i.edge);
           t.surface += num(i.surface);
           t.broken += num(i.broken);
           return t;
         }, {cartons:0,pieces:0,etiquettes:0,edge:0,surface:0,broken:0});
    %>

    <div class="mt-3">
      <h5 class="text-primary">ðŸ”¹ <%= kOption %></h5>

      <% moisListe.forEach(mois => { 
           const lignesMois = lignesK.filter(l => l.mois === mois);
           if (!lignesMois.length) return;

           const totalMois = lignesMois.reduce((t,i)=>{
             t.cartons += num(i.cartons);
             t.pieces += num(i.pieces);
             t.etiquettes += num(i.etiquettes);
             t.edge += num(i.edge);
             t.surface += num(i.surface);
             t.broken += num(i.broken);
             return t;
           }, {cartons:0,pieces:0,etiquettes:0,edge:0,surface:0,broken:0});
      %>

      <h6 class="mt-2 text-secondary">ðŸ“… <%= mois %></h6>

      <div class="table-responsive">
      <table class="table table-bordered table-striped text-center">
        <thead class="table-secondary">
          <tr>
            <th>Date</th>
            <th>Cartons</th>
            <th>PiÃ¨ces</th>
            <th>Ã‰tiquettes</th>
            <th>Edge</th>
            <th>Surface</th>
            <th>Broken</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% lignesMois.forEach(l => { %>
          <tr>
            <td><%= l.date %></td>
            <td><%= l.cartons %></td>
            <td><%= l.pieces %></td>
            <td><%= l.etiquettes %></td>
            <td><%= l.edge %></td>
            <td><%= l.surface %></td>
            <td><%= l.broken %></td>
            <td>
              <form action="/rapport/delete/<%= l._id %>" method="POST"
                onsubmit="return confirm('Voulez-vous vraiment supprimer cette ligne ?');">
                <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
              </form>
            </td>
          </tr>
          <% }) %>
        </tbody>
        <tfoot>
          <tr class="table-success fw-bold">
            <td>TOTAL</td>
            <td><%= totalMois.cartons %></td>
            <td><%= totalMois.pieces %></td>
            <td><%= totalMois.etiquettes %></td>
            <td><%= totalMois.edge %></td>
            <td><%= totalMois.surface %></td>
            <td><%= totalMois.broken %></td>
            <td>-</td>
          </tr>
        </tfoot>
      </table>
      </div>

      <% }) %> <!-- fin mois -->
    </div>

    <!-- ====== Total par K ====== -->
    <table class="table table-bordered table-success text-center mt-2">
      <thead>
        <tr>
          <th>Total pour <%= kOption %></th>
          <th>Cartons</th>
          <th>PiÃ¨ces</th>
          <th>Ã‰tiquettes</th>
          <th>Edge</th>
          <th>Surface</th>
          <th>Broken</th>
        </tr>
      </thead>
      <tbody>
        <tr class="fw-bold">
          <td><%= kOption %></td>
          <td><%= totalK.cartons %></td>
          <td><%= totalK.pieces %></td>
          <td><%= totalK.etiquettes %></td>
          <td><%= totalK.edge %></td>
          <td><%= totalK.surface %></td>
          <td><%= totalK.broken %></td>
        </tr>
      </tbody>
    </table>

    <% }) %> <!-- fin K -->
  <% } %> <!-- fin else lignesGroupe -->

</div>
<% }) %> <!-- fin groupes -->

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
